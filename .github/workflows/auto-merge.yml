name: Auto Merge

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    branches:
      - main
      - develop

jobs:
  enable-auto-merge:
    name: Enable Auto-Merge
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check if PR is draft
        id: check-draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft --jq '.isDraft')

          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "PR #$PR_NUMBER - Draft: $IS_DRAFT"

      - name: Enable auto-merge
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "Enabling auto-merge for PR #$PR_NUMBER..."

          # Enable auto-merge with merge commit (--merge)
          gh pr merge "$PR_NUMBER" --auto --merge

          echo "âœ“ Auto-merge enabled for PR #$PR_NUMBER"
          echo "The PR will be automatically merged when all required checks pass."

      - name: Skip draft PR
        if: steps.check-draft.outputs.is_draft == 'true'
        run: |
          echo "PR #${{ github.event.pull_request.number }} is a draft - auto-merge not enabled"
