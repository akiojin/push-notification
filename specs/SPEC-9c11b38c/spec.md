# 機能仕様書: Unity Push通知Plugin

**機能ID**: `SPEC-9c11b38c`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Unity Push通知Plugin - iOS/Android Native SDKのC#ラッパー、UPM配布"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 簡単なUnity統合 (優先度: P1)

Unity開発者がモバイルゲームにPush通知機能を簡単に追加できる。わずか3行のコードでiOS/Android両プラットフォームのPush通知を統合し、プレイヤーにリアルタイムで情報を届けられる。複雑なネイティブコード記述やプラットフォーム別実装が不要。

**この優先度の理由**: 開発者の生産性向上が最優先。Unity開発者はC#に慣れているが、iOSのSwiftやAndroidのKotlinには不慣れなため、統一されたC# APIが必須。

**独立テスト**: Unityプロジェクトを新規作成し、Pluginをインストール後、3行の初期化コードを記述。Unity Editorでプレイモードで実行し、疑似トークンが生成されることを確認。実機ビルドして実際のデバイストークンを取得、REST APIに登録されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** Unity開発者が新規Unityプロジェクト（2021.3 LTS）を作成済み、**実行** Pluginをインストールし、初期化コードをMonoBehaviourスクリプトに記述、**結果** Unity Editorでプレイモードを実行すると疑似トークンが生成され、コンソールにログが表示される
2. **前提** Pluginが正しく初期化されている、**実行** iOS実機ビルドを実行、**結果** アプリ起動時に実際のAPNsデバイストークンが自動取得され、REST APIに登録される
3. **前提** Pluginが正しく初期化されている、**実行** Android実機ビルドを実行、**結果** アプリ起動時に実際のFCMデバイストークンが自動取得され、REST APIに登録される
4. **前提** デバイストークンが登録済み、**実行** サーバーからPush通知を送信、**結果** iOS/Androidデバイスに通知が表示され、タップでアプリが起動する

---

### ユーザーストーリー2 - 通知コールバック処理 (優先度: P2)

Unity開発者が通知受信時にゲームロジックを実行できる。例えば、「イベント開始」通知を受信したらイベントシーンに遷移、「フレンドリクエスト」通知を受信したらフレンド画面を開くなど、通知内容に応じてゲーム内の適切な画面を表示できる。

**この優先度の理由**: プレイヤーエンゲージメント向上のため。通知から直接ゲーム内の関連コンテンツに誘導することで、プレイヤーの行動完了率が大幅に向上する。

**独立テスト**: 通知コールバック関数を登録し、Unity Editorの疑似通知送信UIから通知を送信。コールバックが呼び出され、通知データが正しく渡されることを確認。実機でも同様にテスト可能。

**受け入れシナリオ**:

1. **前提** 通知コールバック関数が登録されている、**実行** Unity Editorで疑似通知を送信、**結果** コールバック関数が呼び出され、通知データ（タイトル、本文、カスタムデータ）がコンソールに表示される
2. **前提** アプリがフォアグラウンドで実行中、**実行** サーバーからPush通知を送信、**結果** コールバック関数が即座に呼び出され、通知データを基にイベントシーンに遷移する
3. **前提** アプリがバックグラウンド状態、**実行** プレイヤーが通知をタップ、**結果** アプリが起動し、コールバック関数が呼び出され、通知データを基にフレンド画面を開く
4. **前提** カスタムデータに画面IDとパラメータが含まれる、**実行** プレイヤーが通知をタップ、**結果** Unityのシーン管理システムを使用して指定された画面に遷移し、パラメータが渡される

---

### ユーザーストーリー3 - Unity Package Manager配布 (優先度: P3)

Unity開発者がPluginを簡単にインストール・更新できる。Unity Package Managerから直接インストールし、依存関係が自動解決され、サンプルシーンで動作確認できる。

**この優先度の理由**: 開発者体験の向上。手動でファイルをコピーする従来の方法に比べ、UPM配布は依存関係管理が容易で、更新も簡単。

**独立テスト**: Unity Package Managerを開き、Git URL経由でPluginをインストール。サンプルシーンをインポートし、Unity Editorで実行。疑似通知送信が動作することを確認。

**受け入れシナリオ**:

1. **前提** Unity 2021.3 LTS以降がインストール済み、**実行** Package ManagerでGit URLを指定してPluginをインストール、**結果** Pluginが自動的にダウンロードされ、Packagesフォルダに配置される
2. **前提** Pluginがインストール済み、**実行** Package Managerからサンプルシーンをインポート、**結果** Assets/Samples/ディレクトリにサンプルシーンが配置され、Unity Editorで開ける
3. **前提** サンプルシーンをインポート済み、**実行** Unity Editorでサンプルシーンを開きプレイモードで実行、**結果** 疑似通知送信UIが表示され、通知送信ボタンをクリックすると疑似通知が受信される
4. **前提** Pluginの新しいバージョンがリリースされた、**実行** Package Managerで更新ボタンをクリック、**結果** 最新版が自動的にダウンロードされ、既存の設定が保持される

---

### エッジケース

- **Unity Editorモード**: 実機なしでも動作確認できるよう、Unity Editorでは疑似トークン生成と疑似通知受信をサポート
- **プラットフォーム切り替え**: Unity Build SettingsでiOS↔Android切り替え時、適切なNative SDKが自動選択される
- **ネイティブSDK不在**: iOS/Android Native SDKが正しく配置されていない場合、初期化時にエラーメッセージを表示
- **コールバック未登録**: 通知コールバックが登録されていない場合、デフォルトでログ出力のみ行う
- **通知許可拒否**: プレイヤーが通知許可を拒否した場合、適切なエラーメッセージを表示し、設定画面への誘導を提案
- **アプリ起動時の通知処理**: アプリ終了状態から通知タップで起動した場合、初期化完了後にコールバックを呼び出す

## 要件 *(必須)*

### 機能要件

- **FR-001**: Pluginは開発者がAPIキーとエンドポイントを指定してPush通知機能を初期化できる必要がある
- **FR-002**: PluginはiOS/Androidプラットフォームを自動検出し、適切なNative SDKを呼び出せる必要がある
- **FR-003**: PluginはUnity Editorでも動作確認できるよう、疑似トークン生成と疑似通知受信機能を提供する必要がある
- **FR-004**: Pluginは通知受信時にUnityのメインスレッドでコールバック関数を実行できる必要がある
- **FR-005**: Pluginは通知データ（タイトル、本文、画像URL、カスタムデータ）をC#オブジェクトとして提供する必要がある
- **FR-006**: Pluginはプレイヤーアカウント IDを デバイストークンに紐付けできる必要がある
- **FR-007**: Pluginはユーザーログアウト時にデバイストークンを登録解除できる必要がある
- **FR-008**: PluginはUnity Package Manager形式で配布され、Git URL経由でインストール可能である必要がある
- **FR-009**: Pluginはサンプルシーンを提供し、開発者が動作確認できる必要がある
- **FR-010**: Pluginはインストール・統合・使用方法を説明するドキュメントを提供する必要がある

### 主要エンティティ

- **NotificationData**: 通知データを表すC#クラス。タイトル、本文、画像URL、カスタムデータ（Key-Valueペア）を含む。JSON文字列から自動変換される。
- **PushNotificationManager**: Plugin のメインエントリポイント。初期化、トークン管理、コールバック登録を担当するシングルトンクラス。
- **EditorNotificationSimulator**: Unity Editor専用の疑似通知送信UI。Editor Windowとして提供され、開発者が実機なしで動作確認できる。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、別SPECまたは将来のバージョンで対応予定:

- サーバーサイドREST API実装（SPEC-2d193ce6で対応）
- iOS Native SDK実装（SPEC-58d1c0d1で対応）
- Android Native SDK実装（SPEC-628d6000で対応）
- Unreal Engine固有のC++実装（別SPECで対応）
- カスタム通知UI（OS標準通知のみ対応）
- ローカル通知（スケジューリング機能）
- 通知グループ化・スレッド機能
- WebGL/PC Standaloneプラットフォーム対応

---

## 技術制約 *(該当する場合)*

- Unity 2021.3 LTS以降のみサポート
- iOS 14+、Android 7.0+対応（Native SDKの制約）
- Unity Package Manager形式（.unitypackage非対応）
- .NET Standard 2.1準拠

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- iOS Native SDK（SPEC-58d1c0d1）が実装され、.framework形式で提供されている
- Android Native SDK（SPEC-628d6000）が実装され、.aar形式で提供されている
- REST APIサーバー（SPEC-2d193ce6）がデプロイされ、APIキーが発行されている
- 開発者がUnityの基本知識（MonoBehaviour、Coroutine、SceneManager）を持っている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **SPEC-58d1c0d1**: iOS Native SDK（iOSビルド時に.framework埋め込み）
- **SPEC-628d6000**: Android Native SDK（Androidビルド時に.aar埋め込み）
- **SPEC-2d193ce6**: Push通知REST API（デバイストークン登録、通知送信エンドポイント）
- **Unity Engine**: 2021.3 LTS以降
- **Firebase**: iOS/Androidでのpush通知配信サービス

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. Unity開発者がPluginをインストールし、最初の通知を受信するまでに30分以内で完了できる
2. Plugin初期化時間がアプリ起動から3秒以内に完了する
3. 通知コールバックの遅延が通知受信から0.5秒以内である
4. サンプルシーンがUnity Editorで正常に動作し、疑似通知送受信ができる
5. iOS/Android実機ビルドが正常に動作し、実際の通知を送受信できる
6. Pluginのクラッシュ率が0.1%以下である
7. Unity 2021.3 LTS〜2023.2で動作することが検証される
8. ドキュメントが明確で、開発者が自力で統合を完了できる

**成功基準ガイドライン**:

成功基準は以下の条件を満たす必要があります:

1. **測定可能**: 具体的な指標を含む（時間、パーセンテージ、カウント、レート）
2. **技術に依存しない**: フレームワーク、言語、データベース、ツールに言及しない
3. **ユーザー重視**: システム内部ではなく、ユーザー/ビジネスの視点から結果を説明
4. **検証可能**: 実装の詳細を知らなくてもテスト/検証できる
