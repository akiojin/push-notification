# 機能仕様書: Android Native Push通知SDK

**機能ID**: `SPEC-628d6000`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Android Native Push通知SDK - Kotlin実装でFCM統合、シンプルな初期化、トークン自動登録、通知受信ハンドリングを提供"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 簡単なAndroidアプリ統合 (優先度: P1)

ゲームアプリ開発者がAndroidアプリにPush通知機能を数分で統合できる。開発者は3行のコードを記述するだけで、デバイストークンの取得・登録、通知受信、表示が自動的に動作する。複雑なFirebase設定やトークン管理ロジックを実装する必要がない。

**この優先度の理由**: 開発者の生産性向上が最優先。統合の複雑さがSDK採用のボトルネックとなるため、最小限のコードで動作することが必須。

**独立テスト**: サンプルAndroidアプリにSDKを統合し、初期化コードを記述後、アプリを起動してデバイストークンが自動登録されることを確認。REST APIからテスト通知を送信し、通知が正常に表示されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** Android開発者が新規ゲームプロジェクトを作成済み、**実行** SDKをGradle依存関係に追加し、3行の初期化コードをApplicationクラスに記述、**結果** アプリ起動時にデバイストークンが自動取得され、サーバーに登録される
2. **前提** デバイストークンがサーバーに登録済み、**実行** サーバーからPush通知を送信、**結果** アプリがバックグラウンド状態でも通知が表示され、タップでアプリが起動する
3. **前提** アプリがフォアグラウンド実行中、**実行** サーバーからPush通知を送信、**結果** 通知が即座に表示され、カスタムハンドラーが呼び出される
4. **前提** アプリがアンインストール後に再インストールされた、**実行** アプリを起動、**結果** 新しいデバイストークンが自動取得され、古いトークンが無効化される

---

### ユーザーストーリー2 - カスタム通知ハンドリング (優先度: P2)

ゲーム開発者が通知タップ時にプレイヤーを特定のゲーム画面に誘導できる。例えば、「イベント開始」通知をタップしたらイベント画面に、「フレンドリクエスト」通知をタップしたらフレンド画面に遷移させる。通知ペイロードに含まれるカスタムデータ（ディープリンク情報）を取得し、適切な画面を開く。

**この優先度の理由**: プレイヤーエンゲージメント向上のため。通知から直接関連画面に誘導することで、プレイヤーの行動完了率が大幅に向上する。

**独立テスト**: カスタムデータを含む通知を送信し、通知タップ時にコールバック関数が正しいデータとともに呼び出されることを確認。アプリがバックグラウンド/フォアグラウンド両方の状態でテスト可能。

**受け入れシナリオ**:

1. **前提** カスタムデータ（画面ID、パラメータ）を含む通知が送信された、**実行** プレイヤーが通知をタップ、**結果** アプリが起動し、指定された画面（例: イベント画面）が開く
2. **前提** アプリがフォアグラウンド実行中で通知が届く、**実行** プレイヤーが通知をタップ、**結果** 現在の画面の上に新しい画面がスタックされ、指定された画面が表示される
3. **前提** 通知にディープリンクURL（例: `mygame://event/123`）が含まれる、**実行** プレイヤーが通知をタップ、**結果** アプリがURLを解析し、イベントID=123のイベント画面を開く
4. **前提** 開発者がカスタムハンドラーを登録済み、**実行** 通知が届く、**結果** カスタムハンドラーが呼び出され、通知データが渡される

---

### ユーザーストーリー3 - リッチ通知対応 (優先度: P3)

プロダクトマネージャーが視覚的に魅力的な通知を配信し、プレイヤーのエンゲージメントを向上させる。画像付き通知（イベントバナー、キャラクター画像など）やアクションボタン（「今すぐプレイ」「詳細を見る」「後で通知」など）を表示できる。

**この優先度の理由**: ユーザーエンゲージメントの最大化。リッチ通知は通常のテキスト通知に比べてタップ率が大幅に向上し、プレイヤーの再訪率を高める。

**独立テスト**: 画像URLとアクションボタンを含む通知を送信し、Androidデバイスで画像が表示され、各アクションボタンが機能することを確認。

**受け入れシナリオ**:

1. **前提** 通知に画像URL（イベントバナー）が含まれる、**実行** 通知が届く、**結果** 通知バーに画像が表示され、通知を展開すると大きな画像が表示される
2. **前提** 通知に2つのアクションボタン（「今すぐプレイ」「後で通知」）が含まれる、**実行** プレイヤーが「今すぐプレイ」をタップ、**結果** アプリが起動し、イベント画面が開く
3. **前提** 通知にカスタムサウンドが指定されている、**実行** 通知が届く、**結果** 指定されたサウンドが再生される
4. **前提** Android 8.0+デバイスで通知チャンネルが設定されている、**実行** プレイヤーが通知設定を開く、**結果** 「イベント通知」「フレンド通知」などのチャンネル別に通知設定を変更できる

---

### エッジケース

- **ネットワーク切断時**: デバイストークン登録が失敗した場合、SDKは自動的にリトライ（Exponential Backoff）を行い、ネットワーク復旧後に再試行する
- **トークン更新**: Firebaseがデバイストークンを更新した場合、SDKは自動的に新しいトークンをサーバーに送信し、古いトークンを無効化する
- **アプリアンインストール**: プレイヤーがアプリをアンインストールした場合、サーバーは配信失敗を検知し、該当トークンを無効化する（FCMからのフィードバック）
- **通知許可拒否**: プレイヤーが通知許可を拒否した場合、SDKは通知を表示せず、オプトアウト状態として扱う
- **画像読み込み失敗**: リッチ通知で画像URLが無効または読み込み失敗した場合、SDKはテキストのみの通知を表示し、エラーをログに記録する
- **古いAndroidバージョン**: Android 7.0未満のデバイスでは、SDKは初期化時にエラーメッセージを表示し、最小バージョン要件を通知する

## 要件 *(必須)*

### 機能要件

- **FR-001**: SDKは開発者がAPIキーとエンドポイントを指定してPush通知機能を初期化できる必要がある
- **FR-002**: SDKはアプリ起動時にデバイストークンを自動取得し、REST APIに登録できる必要がある（プレイヤーアカウントIDとの紐付けもオプションで可能）
- **FR-003**: SDKは通知受信時にタイトル、本文、画像URL、カスタムデータを解析し、通知として表示できる必要がある
- **FR-004**: SDKは通知タップ時にカスタムデータを取得し、開発者が登録したコールバック関数を呼び出せる必要がある
- **FR-005**: SDKはAndroid 8.0以降の通知チャンネルを管理でき、開発者がカスタムチャンネルを追加できる必要がある
- **FR-006**: SDKは画像付き通知とアクションボタン（最大3個）を表示できる必要がある
- **FR-007**: SDKはネットワークエラー時に自動リトライを行い、エラーログを出力できる必要がある
- **FR-008**: SDKはプレイヤーが通知許可を管理でき、オプトアウト機能を提供する必要がある
- **FR-009**: SDKはパッケージ形式でUnity/Unreal EngineのC++/JNIブリッジから利用できる必要がある
- **FR-010**: SDKはアプリ起動から5秒以内に初期化を完了し、トークン登録API呼び出しは3秒以内に完了する必要がある
- **FR-011**: SDKはREST APIと連携し、通知配信ステータスを取得できる必要がある
- **FR-012**: SDKはGradle依存関係として提供され、開発者が簡単にプロジェクトに追加できる必要がある
- **FR-013**: SDKはAPI仕様ドキュメント、Quickstartガイド、サンプルアプリを提供する必要がある

### 主要エンティティ

- **デバイストークン**: Androidデバイスを一意に識別するトークン。Firebaseから取得され、サーバーに登録される。プレイヤーアカウントIDとの紐付けも可能。
- **通知メッセージ**: サーバーから送信される通知データ。タイトル、本文、画像URL、カスタムデータ（ディープリンク、パラメータなど）を含む。
- **通知チャンネル**: Android 8.0以降で通知をカテゴリ別に管理するための設定単位。「イベント通知」「フレンド通知」などの種類に分けられる。
- **カスタムデータ**: 通知に含まれる追加情報。画面ID、パラメータ、ディープリンクURLなどを含み、通知タップ時の画面遷移に使用される。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、別SPECまたは将来のバージョンで対応予定:

- サーバーサイドREST API実装（SPEC-2d193ce6で対応）
- Unity固有のC#バインディング実装（別SPECで対応）
- Unreal Engine固有のC++ラッパー実装（別SPECで対応）
- HMS（Huawei Mobile Services）対応（中国市場向け代替通知サービス）
- カスタム通知レイアウト（標準のNotificationCompatスタイルのみ対応）
- 通知グループ化（複数通知をまとめて表示する機能）
- 通知スケジューリング（ローカル通知の遅延配信）

---

## 技術制約 *(該当する場合)*

- Android 7.0（API Level 24）以降のみサポート
- Google Play Services（Firebase Cloud Messaging SDK）がインストールされている必要がある
- ProGuard/R8使用時は専用のルールファイルが必要
- 通知画像のサイズ制限: 最大1MB、推奨サイズ512x256px
- 通知本文の最大文字数: 500文字
- アクションボタンの最大数: 3個

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- Firebaseプロジェクトが作成され、google-services.jsonファイルがAndroidプロジェクトに配置されている
- REST APIサーバー（SPEC-2d193ce6）がデプロイされ、APIキーが発行されている
- 開発者がAndroid開発の基本知識（Kotlin、Gradle、Androidアプリライフサイクル）を持っている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **SPEC-2d193ce6**: Push通知REST API（デバイストークン登録、通知送信、配信ステータス取得エンドポイント）
- **Firebase Cloud Messaging**: Googleが提供するPush通知配信サービス（FCM SDK v23.0+）
- **Google Play Services**: FCM SDKの基盤となるAndroidライブラリ

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. Android開発者がSDKを統合し、最初の通知を受信するまでに30分以内で完了できる
2. SDK初期化時間がアプリ起動から5秒以内に完了する
3. デバイストークン登録成功率が95%以上である（ネットワーク接続がある環境下）
4. 通知受信から表示までの遅延が1秒以内である
5. サンプルアプリが正常にビルド・実行でき、通知送受信が動作する
6. SDKのクラッシュ率が0.1%以下である
7. ProGuard/R8適用後もSDKが正常に動作する
8. Android 8.0〜14の全バージョンで通知が正常に表示される

**成功基準ガイドライン**:

成功基準は以下の条件を満たす必要があります:

1. **測定可能**: 具体的な指標を含む（時間、パーセンテージ、カウント、レート）
2. **技術に依存しない**: フレームワーク、言語、データベース、ツールに言及しない
3. **ユーザー重視**: システム内部ではなく、ユーザー/ビジネスの視点から結果を説明
4. **検証可能**: 実装の詳細を知らなくてもテスト/検証できる
