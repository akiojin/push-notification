# 機能仕様書: iOS用Push通知SDKライブラリ

**機能ID**: `SPEC-58d1c0d1`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "iOS用Push通知SDKライブラリ。APNsと統合し、デバイストークン管理、通知受信ハンドラー、カスタムデータ処理、リッチ通知（画像・アクション）をサポート。Swift Package Manager対応、CocoaPods配布。Unity/Unreal Engine統合のためのObjective-Cブリッジも提供。REST API（SPEC-2d193ce6）と連携してトークン登録・更新を行う。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - ゲーム開発者がiOSアプリに通知機能を簡単に統合できる (優先度: P1)

ゲーム開発者は、複雑な設定なしでiOSアプリにPush通知機能を追加したい。数行のコードでSDKを初期化し、通知許可をリクエストし、デバイス識別子を自動的にサーバーに登録できることで、開発時間を短縮し、エラーを減らす。

**この優先度の理由**: SDKの基本的な統合機能がなければ、開発者は通知システムを使えない。すべての他の機能はこの統合機能の上に成り立つ。

**独立テスト**: 開発者がSDKを初期化し、通知許可を取得し、デバイス識別子が自動登録されることを確認できることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 開発者がiOSアプリプロジェクトを持っている、**実行** SDKを3行以内のコードで初期化する、**結果** SDKが正常に初期化され、通知システムが使用可能になる
2. **前提** アプリが初回起動された、**実行** SDK初期化時に通知許可をリクエストする、**結果** iOSの通知許可ダイアログが表示され、ユーザーが許可/拒否を選択できる
3. **前提** ユーザーが通知を許可した、**実行** システムがデバイス識別子を取得する、**結果** デバイス識別子が自動的にバックエンドサーバーに登録され、通知送信が可能になる
4. **前提** デバイス識別子の登録に失敗した、**実行** SDKがエラーハンドラーを呼び出す、**結果** 開発者に分かりやすいエラーメッセージが通知され、リトライ方法が提示される

---

### ユーザーストーリー2 - プレイヤーが通知をタップしたときにゲーム内の適切な画面に遷移できる (優先度: P2)

ゲーム開発者は、プレイヤーが通知をタップしたときに、通知の内容に応じてゲーム内の特定の画面（新しいミッション、フレンドリクエスト、ショップなど）に直接遷移させたい。カスタムデータを通知に含め、アプリ起動時にそのデータを取得できることで、ユーザー体験を向上させる。

**この優先度の理由**: 基本的な通知受信（P1）ができても、通知タップ時のカスタム処理ができなければ、ユーザーを適切な画面に誘導できず、エンゲージメントが低下する。

**独立テスト**: 開発者が通知にカスタムデータを含め、アプリ起動時にそのデータを取得し、適切な画面に遷移できることを確認できることでテスト可能。

**受け入れシナリオ**:

1. **前提** 通知にカスタムデータ（例：ミッションID）が含まれている、**実行** プレイヤーが通知をタップしてアプリを起動する、**結果** アプリがカスタムデータを取得し、開発者が定義したハンドラーが呼び出される
2. **前提** ハンドラーがカスタムデータを受け取った、**実行** 開発者がカスタムデータに基づいて画面遷移ロジックを実装する、**結果** プレイヤーが通知に関連するゲーム画面（例：ミッション詳細）に直接遷移する
3. **前提** アプリがフォアグラウンドで動作中に通知を受信した、**実行** SDKが通知受信ハンドラーを呼び出す、**結果** 開発者がアプリ内通知バナーを表示するか、無視するかを制御できる
4. **前提** アプリがバックグラウンドで通知を受信した、**実行** プレイヤーが後でアプリを開く、**結果** 未処理の通知データが保持されており、開発者がアプリ起動時に取得できる

---

### ユーザーストーリー3 - プレイヤーにリッチな通知体験を提供できる (優先度: P3)

ゲーム開発者は、画像付き通知やアクションボタン付き通知を送信して、プレイヤーの注目を引きたい。通知に画像（アイテムアイコン、キャラクター画像など）を添付し、複数のアクションボタン（「確認」「後で」など）を提供できることで、通知の視覚的魅力と利便性を向上させる。

**この優先度の理由**: 基本的な通知受信（P1）とカスタム処理（P2）ができれば機能的には十分だが、リッチ通知は付加価値であり、ユーザー体験をさらに向上させる。

**独立テスト**: 開発者が画像URLを含む通知を送信し、デバイスが画像付き通知を表示できること、アクションボタンをタップした際にハンドラーが呼び出されることを確認できることでテスト可能。

**受け入れシナリオ**:

1. **前提** 通知に画像URLが含まれている、**実行** プレイヤーがiOSデバイスで通知を受信する、**結果** 通知センターに画像付き通知が表示され、視覚的に魅力的になる
2. **前提** 通知に複数のアクションボタンが定義されている、**実行** プレイヤーが通知を長押しまたはスワイプする、**結果** アクションボタン（例：「確認」「スキップ」）が表示され、プレイヤーが選択できる
3. **前提** プレイヤーがアクションボタンをタップした、**実行** SDKがアクションハンドラーを呼び出す、**結果** 開発者がどのボタンが押されたかを識別し、適切な処理を実行できる
4. **前提** 画像URLが無効または読み込みに失敗した、**実行** デバイスが通知を受信する、**結果** 画像なしで通知が表示され、エラーでアプリがクラッシュしない

---

### エッジケース

- ユーザーが通知許可を拒否した場合、SDKはエラーを報告し、開発者に設定画面への誘導方法を提供する
- デバイス識別子の取得に失敗した場合（ネットワークエラー、サーバーエラー）、SDKは自動的にリトライし、失敗時は開発者にエラーハンドラーを通知する
- アプリがアンインストールされた場合、サーバー側でデバイス識別子が自動的に削除される（バックエンドSPEC-2d193ce6の責任）
- 通知のカスタムデータが不正な形式の場合、SDKはデフォルトハンドラーを呼び出し、エラー情報をログに記録する
- 複数の通知が短時間に連続して届いた場合、SDKは各通知を個別に処理し、データの混同を防ぐ
- アプリがバックグラウンドで強制終了された場合でも、通知タップ時に正しくアプリが起動し、カスタムデータが取得できる

## 要件 *(必須)*

### 機能要件

- **FR-001**: SDKは開発者が3行以内のコードで初期化できる必要がある
- **FR-002**: SDKは初期化時にiOS通知許可をリクエストできる必要がある
- **FR-003**: SDKはユーザーが通知を許可した際に、デバイス識別子を自動的に取得する必要がある
- **FR-004**: SDKは取得したデバイス識別子をバックエンドサーバー（SPEC-2d193ce6）に自動登録する必要がある
- **FR-005**: SDKは通知受信時にカスタムハンドラーを呼び出せる必要がある（フォアグラウンド/バックグラウンド両方）
- **FR-006**: SDKは通知タップ時にカスタムデータを開発者に提供する必要がある
- **FR-007**: SDKは通知に含まれる画像を自動的にダウンロードして表示できる必要がある
- **FR-008**: SDKは通知にアクションボタンを定義できる必要がある
- **FR-009**: SDKはアクションボタンのタップイベントを開発者に通知する必要がある
- **FR-010**: SDKはデバイス識別子の更新（OSアップデート時など）を自動的に検出し、サーバーに通知する必要がある
- **FR-011**: SDKはUnity/Unreal Engineから呼び出せるObjective-Cブリッジを提供する必要がある
- **FR-012**: SDKはネットワークエラー時に自動的にリトライする必要がある（デバイス識別子登録時）
- **FR-013**: SDKはエラー発生時に開発者にわかりやすいエラーメッセージを提供する必要がある

### 主要エンティティ

- **デバイス識別子**: iOSデバイス固有の通知トークン、プラットフォーム（iOS）、アプリ起動時に自動取得
- **通知データ**: タイトル、本文、画像URL、カスタムデータ（JSON形式）、アクション定義
- **通知ハンドラー**: 開発者が定義するコールバック関数、通知受信時・タップ時に呼び出される
- **サーバー接続設定**: バックエンドサーバーのURL、APIキー、タイムアウト設定

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- Android版SDKの開発（別SPEC: Android Native SDK）
- 通知のスケジュール送信（サーバー側の機能）
- 通知の開封率トラッキング（アナリティクス機能）
- ローカル通知（アプリ内で生成される通知）
- 通知グルーピング機能
- サイレント通知（バックグラウンドでデータ同期）

---

## 技術制約 *(該当する場合)*

- iOS 13.0以上をサポート（APNs要件）
- Xcode 14.0以上が必要
- iOSデバイスでのみ動作（シミュレーターではAPNs通知を受信できない）
- Apple Developer Programアカウントが必要（APNs証明書/キー取得のため）
- 通知ペイロードサイズは4KB以内（APNs制限）

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ゲーム開発者がiOSアプリ開発の基本知識を持っている
- バックエンドサーバー（SPEC-2d193ce6）が稼働している
- Apple Developer ProgramでAPNs証明書またはキーが発行されている
- ゲームアプリがApp Storeまたは TestFlightで配布されている（またはテスト用にAd-Hoc配布）

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **SPEC-2d193ce6**: バックエンドREST APIサーバー（デバイストークン登録・更新・削除エンドポイント）
- **Apple APNs**: iOS通知配信サービス
- **iOS UserNotifications Framework**: iOS標準通知API

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 開発者がSDKを統合するまでの時間が30分以内である（ドキュメント参照～動作確認まで）
2. SDK初期化から通知受信準備完了までの時間が5秒以内である
3. 通知受信からハンドラー呼び出しまでの時間が1秒以内である
4. デバイス識別子のサーバー登録成功率が95%以上である（ネットワーク正常時）
5. 通知タップ時のカスタムデータ取得成功率が100%である
6. 画像付き通知の画像表示成功率が90%以上である（画像URLが有効な場合）
7. SDKのクラッシュ率が0.1%以下である
8. 開発者向けドキュメントが明確で、サンプルコードが動作する
