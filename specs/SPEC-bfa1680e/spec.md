# 機能仕様書: Unreal Engine Push通知Plugin

**機能ID**: `SPEC-bfa1680e`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Unreal Engine Push通知Plugin - iOS/Android Native SDKのC++ラッパー、Marketplace配布"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 簡単なUnreal統合 (優先度: P1)

Unreal Engine開発者がモバイルゲームにPush通知機能を簡単に追加できる。わずか3行のC++コードまたはBlueprintノードでiOS/Android両プラットフォームのPush通知を統合し、プレイヤーにリアルタイムで情報を届けられる。複雑なネイティブコード記述やプラットフォーム別実装が不要。

**この優先度の理由**: 開発者の生産性向上が最優先。Unreal開発者はC++またはBlueprintに慣れているが、iOSのSwiftやAndroidのKotlinには不慣れなため、統一されたUnreal APIが必須。

**独立テスト**: Unreal Engineプロジェクトを新規作成し、Pluginを有効化後、3行の初期化コードをGameModeに記述。Unreal Editorでプレイモードで実行し、疑似トークンが生成されることを確認。実機ビルドして実際のデバイストークンを取得、REST APIに登録されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** Unreal開発者が新規Unreal Engineプロジェクト（5.3以降）を作成済み、**実行** Pluginを有効化し、初期化コードをGameModeクラスに記述、**結果** Unreal Editorでプレイモードを実行すると疑似トークンが生成され、Output Logに表示される
2. **前提** Pluginが正しく初期化されている、**実行** iOS実機ビルドを実行、**結果** アプリ起動時に実際のAPNsデバイストークンが自動取得され、REST APIに登録される
3. **前提** Pluginが正しく初期化されている、**実行** Android実機ビルドを実行、**結果** アプリ起動時に実際のFCMデバイストークンが自動取得され、REST APIに登録される
4. **前提** デバイストークンが登録済み、**実行** サーバーからPush通知を送信、**結果** iOS/Androidデバイスに通知が表示され、タップでアプリが起動する

---

### ユーザーストーリー2 - 通知コールバック処理 (優先度: P2)

Unreal開発者が通知受信時にゲームロジックを実行できる。例えば、「イベント開始」通知を受信したらイベントレベルに遷移、「フレンドリクエスト」通知を受信したらフレンドUIを開くなど、通知内容に応じてゲーム内の適切な画面を表示できる。C++デリゲートまたはBlueprintイベントで実装可能。

**この優先度の理由**: プレイヤーエンゲージメント向上のため。通知から直接ゲーム内の関連コンテンツに誘導することで、プレイヤーの行動完了率が大幅に向上する。

**独立テスト**: 通知コールバックデリゲートをバインドし、Unreal Editorの疑似通知送信UIから通知を送信。コールバックが呼び出され、通知データが正しく渡されることを確認。実機でも同様にテスト可能。

**受け入れシナリオ**:

1. **前提** 通知コールバックデリゲートがバインドされている、**実行** Unreal Editorで疑似通知を送信、**結果** コールバックデリゲートが呼び出され、通知データ（タイトル、本文、カスタムデータ）がOutput Logに表示される
2. **前提** アプリがフォアグラウンドで実行中、**実行** サーバーからPush通知を送信、**結果** コールバックデリゲートが即座に呼び出され、通知データを基にイベントレベルに遷移する
3. **前提** アプリがバックグラウンド状態、**実行** プレイヤーが通知をタップ、**結果** アプリが起動し、コールバックデリゲートが呼び出され、通知データを基にフレンドUIを開く
4. **前提** カスタムデータにレベル名とパラメータが含まれる、**実行** プレイヤーが通知をタップ、**結果** UGameplayStaticsを使用して指定されたレベルに遷移し、パラメータが渡される

---

### ユーザーストーリー3 - Blueprint統合対応 (優先度: P3)

Unrealブループリント開発者がC++コードなしでPush通知機能を使用できる。BlueprintノードでPluginを初期化し、通知コールバックをBlueprintイベントで受け取れる。

**この優先度の理由**: Unrealコミュニティには多くのBlueprint専門開発者がおり、C++なしで開発できることが重要。

**独立テスト**: Blueprintのみでゲームロジックを作成し、PushNotificationノードで初期化、OnNotificationReceivedイベントをBlueprintグラフに実装。Unreal Editorで疑似通知送信し、イベントが発火することを確認。

**受け入れシナリオ**:

1. **前提** Unreal Editorでプロジェクトを開いている、**実行** Blueprint EditorでInitialize Push Notificationノードを配置し、APIキーとエンドポイントをピンに接続、**結果** ノードがエラーなくコンパイルされる
2. **前提** Initialize Push Notificationノードが正しく配置されている、**実行** On Notification Receivedカスタムイベントを作成し、Output Logノードでデータを表示、**結果** Unreal Editorで疑似通知送信時にカスタムイベントが発火し、ログが表示される
3. **前提** Blueprint通知イベントが実装されている、**実行** 実機ビルドして通知を送信、**結果** Blueprintイベントが発火し、指定されたレベルに遷移する
4. **前提** プロジェクトがC++コードを一切含まない、**実行** Pluginを有効化しBlueprint実装のみでビルド、**結果** iOS/Androidビルドが正常に完了し、通知機能が動作する

---

### エッジケース

- **Unreal Editorモード**: 実機なしでも動作確認できるよう、Unreal Editorでは疑似トークン生成と疑似通知受信をサポート
- **プラットフォーム切り替え**: Unreal Project SettingsでiOS↔Android切り替え時、適切なNative SDKが自動選択される
- **ネイティブSDK不在**: iOS/Android Native SDKが正しく配置されていない場合、初期化時にエラーメッセージを表示
- **コールバック未バインド**: 通知コールバックデリゲートがバインドされていない場合、デフォルトでログ出力のみ行う
- **通知許可拒否**: プレイヤーが通知許可を拒否した場合、適切なエラーメッセージを表示し、設定画面への誘導を提案
- **アプリ起動時の通知処理**: アプリ終了状態から通知タップで起動した場合、初期化完了後にコールバックを呼び出す
- **マルチスレッド処理**: Native SDKコールバックが別スレッドから呼ばれても、Unrealゲームスレッドで安全に実行される

## 要件 *(必須)*

### 機能要件

- **FR-001**: Pluginは開発者がAPIキーとエンドポイントを指定してPush通知機能を初期化できる必要がある（C++およびBlueprint）
- **FR-002**: PluginはiOS/Androidプラットフォームを自動検出し、適切なNative SDKを呼び出せる必要がある
- **FR-003**: PluginはUnreal Editorでも動作確認できるよう、疑似トークン生成と疑似通知受信機能を提供する必要がある
- **FR-004**: Pluginは通知受信時にUnrealゲームスレッドでデリゲート/イベントを実行できる必要がある
- **FR-005**: Pluginは通知データ（タイトル、本文、画像URL、カスタムデータ）をFStructとして提供する必要がある
- **FR-006**: PluginはプレイヤーアカウントIDをデバイストークンに紐付けできる必要がある
- **FR-007**: Pluginはユーザーログアウト時にデバイストークンを登録解除できる必要がある
- **FR-008**: PluginはBlueprintノードとして公開され、C++なしで使用可能である必要がある
- **FR-009**: PluginはサンプルマップとサンプルBlueprintを提供し、開発者が動作確認できる必要がある
- **FR-010**: Pluginはインストール・統合・使用方法を説明するドキュメントを提供する必要がある

### 主要エンティティ

- **FPushNotificationData**: 通知データを表すFStruct。タイトル、本文、画像URL、カスタムデータ（TMap<FString, FString>）を含む。JSON文字列から自動変換される。
- **UPushNotificationSubsystem**: PluginのメインエントリポイントのGameInstanceSubsystem。初期化、トークン管理、デリゲートバインドを担当。
- **EditorNotificationToolbar**: Unreal Editor専用の疑似通知送信UI。Editor Utility Widgetとして提供され、開発者が実機なしで動作確認できる。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、別SPECまたは将来のバージョンで対応予定:

- サーバーサイドREST API実装（SPEC-2d193ce6で対応）
- iOS Native SDK実装（SPEC-58d1c0d1で対応）
- Android Native SDK実装（SPEC-628d6000で対応）
- Unity固有のC#実装（SPEC-9c11b38cで対応）
- カスタム通知UI（OS標準通知のみ対応）
- ローカル通知（スケジューリング機能）
- 通知グループ化・スレッド機能
- Windows/Mac/Linux Standalone プラットフォーム対応

---

## 技術制約 *(該当する場合)*

- Unreal Engine 5.3以降のみサポート
- iOS 14+、Android 7.0+対応（Native SDKの制約）
- Unreal Engine Plugin形式（.uplugin）
- C++17準拠

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- iOS Native SDK（SPEC-58d1c0d1）が実装され、.framework形式で提供されている
- Android Native SDK（SPEC-628d6000）が実装され、.aar形式で提供されている
- REST APIサーバー（SPEC-2d193ce6）がデプロイされ、APIキーが発行されている
- 開発者がUnreal Engineの基本知識（GameMode、Blueprint、C++クラス）を持っている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **SPEC-58d1c0d1**: iOS Native SDK（iOSビルド時に.framework埋め込み）
- **SPEC-628d6000**: Android Native SDK（Androidビルド時に.aar埋め込み）
- **SPEC-2d193ce6**: Push通知REST API（デバイストークン登録、通知送信エンドポイント）
- **Unreal Engine**: 5.3以降
- **Firebase**: iOS/Androidでのpush通知配信サービス

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. Unreal開発者がPluginをインストールし、最初の通知を受信するまでに30分以内で完了できる
2. Plugin初期化時間がアプリ起動から3秒以内に完了する
3. 通知コールバックの遅延が通知受信から0.5秒以内である
4. サンプルマップがUnreal Editorで正常に動作し、疑似通知送受信ができる
5. iOS/Android実機ビルドが正常に動作し、実際の通知を送受信できる
6. Pluginのクラッシュ率が0.1%以下である
7. Unreal Engine 5.3〜5.4で動作することが検証される
8. BlueprintのみでC++コードなしで統合が完了できる
9. ドキュメントが明確で、開発者が自力で統合を完了できる
