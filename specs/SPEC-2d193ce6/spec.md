# 機能仕様書: クロスプラットフォームPush通知配信システム

**機能ID**: `SPEC-2d193ce6`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Push通知システムのREST API仕様とリファレンスサーバー実装。OpenAPI 3.0仕様書を定義し、デバイストークン管理（登録・更新・削除）、通知送信、通知状態確認のエンドポイントを提供する。リファレンス実装としてNode.js/TypeScriptでサーバーを開発し、APNs/FCM統合、Docker環境、認証・エラーハンドリングを含む。Unity/Unreal Engine向けPush通知SDKのバックエンド基盤となる。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - ゲーム開発者がユーザーにリアルタイム通知を送信できる (優先度: P1)

ゲーム開発者は、ゲームイベント（新しいミッション、友達リクエスト、アイテム獲得など）が発生したときに、プレイヤーのモバイルデバイスに即座に通知を送信したい。プレイヤーがゲームアプリを開いていなくても、重要な情報をタイムリーに受け取れるようにすることで、エンゲージメントを維持し、プレイヤーの復帰率を向上させる。

**この優先度の理由**: 通知送信はこのシステムの中核的な価値提案であり、これがなければシステムの存在意義がない。すべての他の機能はこの基本機能をサポートするために存在する。

**独立テスト**: 開発者が通知送信リクエストを送信し、対象デバイスが通知を受信できることを確認することで完全にテスト可能。このストーリーだけでMVPとして機能する。

**受け入れシナリオ**:

1. **前提** ゲーム開発者がアクティブなユーザーのデバイス識別子を持っている、**実行** 通知メッセージとデバイス識別子を指定して通知送信をリクエストする、**結果** 対象デバイスが数秒以内に通知を受信し、画面に表示される
2. **前提** ゲーム開発者が複数のプレイヤー（iOS/Android混在）に同時通知したい、**実行** 複数のデバイス識別子を指定して通知を送信する、**結果** すべての対象デバイス（プラットフォーム問わず）が通知を受信する
3. **前提** 通知にゲーム内画像（アイテムアイコンなど）を含めたい、**実行** 画像URLを含む通知を送信する、**結果** デバイスが画像付き通知を表示する
4. **前提** プレイヤーが通知をタップした、**実行** プレイヤーが通知をタップする、**結果** ゲームアプリが起動し、関連するゲーム画面（例：新しいミッション詳細）に直接遷移する

---

### ユーザーストーリー2 - システムがデバイス識別子のライフサイクルを管理できる (優先度: P2)

ゲーム開発者は、プレイヤーのデバイス情報（通知送信先の識別子）を登録、更新、削除できる必要がある。プレイヤーがアプリを初めてインストールしたとき、デバイスを変更したとき、アプリをアンインストールしたときに適切に管理できることで、不要な通知送信コストを削減し、プレイヤーに無関係な通知が届かないようにする。

**この優先度の理由**: 通知送信（P1）を継続的に運用するために必要。デバイス情報の管理なしでは、通知が届かなくなったり、既に削除されたデバイスに送信し続けてコストが無駄になる。

**独立テスト**: 開発者がデバイス識別子を登録、更新、削除し、その変更が通知送信に正しく反映されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** プレイヤーがゲームアプリを初めてインストールした、**実行** アプリがデバイス識別子をシステムに登録する、**結果** システムがデバイス識別子を保存し、以降の通知送信で使用できるようになる
2. **前提** プレイヤーがOSアップデート後にデバイス識別子が変更された、**実行** アプリが新しいデバイス識別子でシステムを更新する、**結果** システムが古い識別子を新しい識別子に置き換え、通知が新しい識別子に届くようになる
3. **前提** プレイヤーがアプリをアンインストールした、**実行** アプリまたはバックエンドがデバイス識別子を削除する、**結果** システムがデバイス識別子を削除し、以降の通知送信対象から除外される
4. **前提** 同じプレイヤーが複数のデバイス（スマートフォン＋タブレット）でゲームをプレイしている、**実行** 両方のデバイス識別子を同じプレイヤーアカウントに関連付ける、**結果** 両方のデバイスに通知が届く

---

### ユーザーストーリー3 - 開発者が通知配信状況を確認できる (優先度: P3)

ゲーム開発者は、送信した通知が正常に配信されたか、エラーが発生したかを確認したい。配信失敗の理由（無効なデバイス識別子、ネットワークエラーなど）を把握することで、問題を迅速にトラブルシューティングし、プレイヤーが重要な通知を見逃さないようにする。

**この優先度の理由**: 通知が送信できても（P1）、配信状況が不明だと、問題が発生していても気づけない。運用上の品質向上に貢献するが、基本的な通知送信機能がなければ意味がないため、P3とする。

**独立テスト**: 開発者が通知を送信し、送信履歴から配信状態（成功/失敗/保留中）とエラー理由を確認できることでテスト可能。

**受け入れシナリオ**:

1. **前提** 開発者が通知を送信した、**実行** 通知の配信状況を確認する、**結果** 送信済み通知の一覧が表示され、各通知の配信状態（成功/失敗/配信中）が表示される
2. **前提** 一部のデバイスへの通知配信が失敗した、**実行** 失敗した通知の詳細を確認する、**結果** 失敗理由（例：無効なデバイス識別子、プラットフォームエラー）が明確に表示される
3. **前提** 大量のプレイヤーに一斉通知を送信した、**実行** 配信完了率を確認する、**結果** 「90%配信完了、5%失敗、5%配信中」のような統計情報が表示される
4. **前提** 配信失敗が発生した、**実行** エラー理由を確認してデバイス識別子を修正する、**結果** 再送信が可能になり、修正後は正常に配信される

---

### エッジケース

- デバイス識別子が無効または期限切れの場合、通知送信は失敗し、開発者にエラー理由が通知される
- 同じデバイス識別子が重複登録されようとした場合、システムは既存の登録を更新する（重複エントリを作成しない）
- ネットワーク障害で通知配信が一時的に失敗した場合、システムは自動的に再試行する
- 無効な画像URLを含む通知を送信した場合、通知は送信されるが画像なしで表示される
- 大量の通知を短時間に送信した場合、システムはレート制限を適用して、プラットフォーム（iOS/Android）の制限を超えないようにする
- プレイヤーがデバイス設定で通知をオフにしている場合、通知は配信されず、開発者にその旨が通知される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは開発者がデバイス識別子を登録できる必要がある（プラットフォーム: iOS/Android）
- **FR-002**: システムは開発者がデバイス識別子を更新できる必要がある（デバイス変更、OS更新時）
- **FR-003**: システムは開発者がデバイス識別子を削除できる必要がある（アンインストール時）
- **FR-004**: システムは開発者が単一または複数のデバイスに通知を送信できる必要がある
- **FR-005**: システムは通知にテキストメッセージ、タイトル、画像、カスタムデータを含められる必要がある
- **FR-006**: システムは通知配信状態を記録する必要がある（成功/失敗/配信中）
- **FR-007**: システムは通知配信失敗時にエラー理由を記録する必要がある
- **FR-008**: システムは開発者が送信済み通知の履歴と配信状況を確認できる必要がある
- **FR-009**: システムはiOSとAndroidの両方のプラットフォームに通知を配信できる必要がある
- **FR-010**: システムは同じプレイヤーの複数デバイスに通知を送信できる必要がある
- **FR-011**: システムは開発者を認証し、不正な通知送信を防止する必要がある
- **FR-012**: システムは通知配信失敗時に自動的に再試行する必要がある（一時的なネットワークエラー時）
- **FR-013**: システムはプラットフォームのレート制限を遵守し、過剰な通知送信を防止する必要がある

### 主要エンティティ

- **デバイス登録情報**: プレイヤーのデバイス識別子、プラットフォーム（iOS/Android）、登録日時、最終更新日時、関連するプレイヤーアカウント
- **通知メッセージ**: タイトル、本文、画像URL、カスタムデータ（ディープリンク情報など）、送信日時
- **配信履歴**: 通知メッセージ、対象デバイス、配信状態（成功/失敗/配信中）、エラー理由（該当する場合）、配信日時

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- 通知のスケジュール送信（特定の日時に通知を送信）
- 地域・言語別の通知カスタマイズ
- 通知の開封率・タップ率の詳細分析
- プレイヤーセグメント別の通知送信（例：VIPプレイヤーのみに送信）
- A/Bテスト機能（異なる通知内容の効果測定）
- 通知テンプレート管理（再利用可能な通知フォーマット）

---

## 技術制約 *(該当する場合)*

- iOS/Androidの公式Push通知プラットフォーム（APNs/FCM）の制約に従う必要がある
- 通知ペイロードサイズ制限（iOS: 4KB、Android: 4KB）を遵守する必要がある
- プラットフォームのレート制限を遵守する必要がある
- デバイス識別子の形式はプラットフォーム固有のフォーマットに従う必要がある

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ゲーム開発者がUnityまたはUnreal Engineでモバイルゲームを開発している
- ゲーム開発者がiOSおよび/またはAndroidプラットフォーム向けにアプリを公開している
- プレイヤーがモバイルデバイスでPush通知を受信できる環境にいる（通知許可がオン）
- 開発者がシステムにアクセスするための認証情報（APIキーなど）を持っている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- iOSプラットフォームのAPNs（Apple Push Notification service）
- AndroidプラットフォームのFCM（Firebase Cloud Messaging）
- インターネット接続（開発者サーバーとプラットフォームサービス間）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 開発者が通知を送信してから、対象デバイスが通知を受信するまでの時間が90%以上のケースで10秒以内である
2. 通知配信成功率が95%以上である（有効なデバイス識別子に対して）
3. 開発者がデバイス識別子を登録、更新、削除する操作が3ステップ以内で完了できる
4. 通知配信失敗時のエラー理由が開発者にとって理解しやすく、修正アクションが明確である
5. システムが10,000デバイスへの同時通知送信をサポートする
6. 開発者が送信済み通知の配信状況を確認するまでの操作が2ステップ以内で完了できる
7. プラットフォーム（iOS/Android）間で通知送信の一貫性が保たれる（開発者が異なる手順を覚える必要がない）
